@page "/products"
@using System.Net.Http
@using System.Net.Http.Json
@using TestBlazorApp.Model
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation

<PageTitle>Продукт</PageTitle>
<h3>Продукт</h3>
@if (errorMessage != null)
{
    <div class="alert alert-danger fade-message">@errorMessage</div>

}
@if (succesMessage != null)
{
    <div class="alert alert-success fade-message">@succesMessage</div>
}
@if (products == null)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>
}
else
{
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Список продуктов</h5>
        </div>

        <div class="row fw-bold">
            <div class="col ms-3"></div>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 30%">Продукт</th>
                            <th style="width: 30%">Категория</th>
                            <th style="width: 30%">Количество</th>
                            <th style="width: 20%"></th>
                            <th style="width: 20%"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in products)
                        {
                            <tr>
                                <td>@product.Productname</td>
                                <td>@product.Categoryname</td>
                                <td>@product.Productcount</td>
                                <td>
                                    <button @onclick="() => UpdateProduct(product)"
                                    class="btn btn-primary mt-2">
                                        Изменить
                                    </button>
                                </td>
                                <td>
                                    <button @onclick="() => DeletedProduct(product)"
                                    class="btn btn-warning mt-2">
                                        Удалить
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer text-muted">
            Всего продуктов: @products.Count
        </div>
    </div>
    <div class="text-end">
        <button @onclick="CreateForm" class="btn btn-primary ms-3 mt-1">Добавить</button>
    </div>
}

<style>
    .fade-message {
        animation: fadeOut 3s ease-in-out forwards;
    }

    @@keyframes fadeOut {
        0% {
            opacity: 1;
        }

        70% {
            opacity: 1;
        }

        100% {
            opacity: 0;
            display: none;
        }
    }
</style>

@code {
    private List<Product> products = new();
    private string? errorMessage;
    private string? succesMessage;

    // Инициализация компонента - загрузка продуктов
    protected override async Task OnInitializedAsync()
    {
        await LoadProduct();
    }

    // Загрузка продуктов из API
    private async Task LoadProduct()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            products = await httpClient.GetFromJsonAsync<List<Product>>("products");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

     // Перенаправление на форму редактирования
    private void UpdateProduct(Product product)
    {
        try
        {
            Navigation.NavigateTo($"/products/form/{product.ProductId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    //Удаление продукта
    private async Task DeletedProduct(Product product)
    {
        try
        {
            errorMessage = null;
            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            await httpClient.DeleteAsync($"products/{product.ProductId}");
            succesMessage = "Продукт удален";
            await LoadProduct();
            _ = HideMessageAfterDelay();
        }
        catch (Exception ex)
        {
            succesMessage = null;
            errorMessage = "Ошибка при убалении";
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    // Затухание сообщения об выполненой операции
    private async Task HideMessageAfterDelay()
    {
        await Task.Delay(3000);
        succesMessage = null;
        StateHasChanged();
    }

    // Перенаправление на форму создания
    private void CreateForm()
    {
        Navigation.NavigateTo("/products/form/new");
    }
}

